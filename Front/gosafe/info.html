<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>One Page Wonder - Start Bootstrap Template</title>

    <!-- Bootstrap Core CSS -->
  
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/one-page-wonder.css" rel="stylesheet">
    <link href="css/freelancer.css" rel="stylesheet">
    
   

    <!-- Custom Fonts -->
    
    

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>

    <!-- Navigation -->
     <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a href="index.html" class="navbar-brand" href="#">Gosafe</a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li class="hidden">
                        <a class="page-scroll" href="#page-top"></a>
                    </li>
                    <li class="page-scroll">
                        <a href="index.html#about">About</a>
                    </li>
                    <li class="page-scroll">
                        <a href="index.html#cities">Region</a>
                    </li>
                    <li class="page-scroll">
                        <a href="#">Crime</a>
                    </li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <form class="navbar-form pull-right">
                        <fb:login-button scope="public_profile,email" onlogin="checkLoginState();" size="large" auto_logout_link=true>
                        </fb:login-button>
                    </form>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Full Width Image Header -->
   <!--  <header class="header-image">
        <div class="headline">
            <div class="container">
                <h1>One Page Wonder</h1>
                <h2>Will Knock Your Socks Off</h2>
            </div>
        </div>
    </header> -->

    <!-- Page Content -->
    <!-- <div class="container">
    	<div class="row">
    		<div class="col-lg-8 col-lg-offset-5">
    			<button type="button" onclick="state()" class="btn btn-lg btn-warning" id="confirm"> Click here </button>
    		</div>
    	</div>
    </div> -->

    
    <div class="container">
    	<div class="row">
    		<div class="col-lg-8 col-lg-offset-5">
    			<p align="left" ></p>
    		</div>
    	</div>
    </div>
    <div class="container">
    	<div class="row">
    		<div class="col-lg-8 col-lg-offset-5">
    			<p align="left" ></p>
    		</div>
    	</div>
    </div>
    <div class="container">
    	<div class="row">
    		<div class="col-lg-8 col-lg-offset-5">
    			<p align="left" ></p>
    		</div>
    	</div>
    </div>
    <div class="container">
    	<div class="row">
    		<div class="col-lg-8 col-lg-offset-5">
    			<p align="left" ></p>
    		</div>
    	</div>
    </div>
    <div class="container">
    	<div class="row">
    		<div class="col-lg-12 col-lg-offset-0">
    			<div class="alert alert-warning text-center" id="info_status">
                    
                </div>
    		</div>
    	</div>
    </div>
    <div class="container">
    	<div class="row">
    		<div class="col-lg-9 col-lg-offset-5">
    			<!-- <button type="button" onclick="state()" class="btn btn-lg btn-warning" id="confirm"> Click here </button> -->
    			<a href="#submit_address" class="btn btn-lg btn-warning" data-toggle="modal" id="button">Submit your address</a>
    		</div>
    	</div>
    </div>
    	
    <div class="container">
        <hr class="featurette-divider">

        <!-- First Featurette -->
        <div class="featurette" id="about">
            <img class="featurette-image img-circle img-responsive pull-right" src="img/portfolio/caution.png">
            <h2 class="featurette-heading">Recent Crimes In Your Area
                <span class="text-muted"></span>
            </h2>
            <!-- <div class="col-lg-8 col-lg-offset-1">
                        <div class="panel panel-yellow">
                            <div class="panel-heading">
                                <h3 class="panel-title">Panel title</h3>
                            </div>
                            <div class="panel-body">
                            Donec ullamcorper nulla non metus auctor fringilla. Vestibulum id ligula porta felis euismod semper. Praesent commodo cursus magna, vel scelerisque nisl consectetur. Fusce dapibus, tellus ac cursus commodo.
                            	Donec ullamcorper nulla non metus auctor fringilla. Vestibulum id ligula porta felis euismod semper. Praesent commodo cursus magna, vel scelerisque nisl consectetur. Fusce dapibus, tellus ac cursus commodo.
                                Donec ullamcorper nulla non metus auctor fringilla. Vestibulum id ligula porta felis euismod semper. Praesent commodo cursus magna, vel scelerisque nisl consectetur. Fusce dapibus, tellus ac cursus commodo.
                            </div>
                        </div>
            </div> -->
            <p class="lead" id="recent-crimes">Log in and see recent crimes happened in your area.</p>
        </div>

        <hr class="featurette-divider">

        <!-- Second Featurette -->
        <div class="featurette" id="about">
            <img class="featurette-image img-circle img-responsive pull-right" src="img/portfolio/security.png">
            <h2 class="featurette-heading">Tips that concern your safety</h2>
            <p class="lead" id="tips">Log in and see those tips that can better protect you and your family.</p>
        </div>

        <hr class="featurette-divider">


	</div>
        <!-- Footer -->
        <footer>
            <div class="row">
                <div class="col-lg-12">
                    <p>Copyright &copy; GoSafe 2014</p>
                </div>
            </div>
        </footer>

    
    
     <!-- Portfolio Modals -->
    <div class="portfolio-modal modal fade" id="submit_address">
        <form role="form">
            
            <div class="modal-content">
                <div class="close-modal" data-dismiss="modal">
                    <div class="lr">
                        <div class="rl">
                        </div>
                    </div>
                </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="modal-body">
                            <!-- <div class="alert alert-danger" id="invalid_date" type="hidden">Invalid Date. Please modify and re-submit again.</div>
                            <div class="alert alert-danger" id="error" type="hidden"></div>
                            <div class="alert alert-success" id="submit_success" type="hidden">Successfully Submitted.</div> -->
                            <h2>Submit</h2>
                            <hr class="star-primary">
                            <div class="row control-group">
                            	<div class="col-lg-8 col-lg-offset-2">
                            		<form role="form">

                            			<div class="form-group has-success">
                                		<label class="control-label" for="inputAddress">Input your address</label>
                                		<input type="text" class="form-control" id="submit_your_address">
                            			</div>
                            		</form>
                            	</div>
                                   <!--  <div class="col-lg-8 col-lg-offset-4">
                                        <p align="left" id="rpt_time"></p> 
                                    </div>
                                    <div class="col-lg-8 col-lg-offset-4">
                                        <p align="left" id="rpt_date"></p> 
                                        <p>Date: rape</p> 
                                    </div>
                                    <div class="col-lg-8 col-lg-offset-4">
                                        <p align="left" id="rpt_loc"></p> 
                                        <p>Location: rape</p> 
                                    </div>
                                    <div class="col-lg-8 col-lg-offset-4">
                                        <p align="left" id="rpt_zip"></p> 
                                    </div>
                                    <div class="col-lg-8 col-lg-offset-4">
                                        <p align="left" id="rpt_type"></p>
                                        <p>Crime Type: rape</p> 
                                    </div> -->
                            </div>
                                    <p></p>
                                    <!-- <div class="form-group col-xs-12 floating-label-form-group controls">
                                        <label>Crime Description</label>
                                        <textarea rows="5" class="form-control" placeholder="Crime description" id="crime_descp" required data-validation-required-message="Please enter the crime description."></textarea>
                                        <p class="help-block text-danger"></p>
                                    </div> -->
                            </div>
                            
                            <button type="button" class="btn btn-lg btn-success" id="confirm"> Confirm </button>

                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>  
    
    
    <!-- /.container -->

    <!-- jQuery -->
    <script src="js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="js/bootstrap.min.js"></script>
    
    <script type="text/javascript">
    	window.onload = function() {
    		state();
    	}
    </script>

    <script>
    // This is called with the results from from FB.getLoginStatus().
    function statusChangeCallback(response) {
      // The response object is returned with a status field that lets the
      // app know the current login status of the person.
      // Full docs on the response object can be found in the documentation
      // for FB.getLoginStatus().
      if (response.status === 'connected') {
          document.getElementById('info_status').innerHTML = "You have successfully logged in."; 
        // Logged into your app and Facebook.
        CheckUser();
      } else if (response.status === 'not_authorized') {
        // The person is logged into Facebook, but not your app.
        document.getElementById('info_status').innerHTML = 'You should log in first.';
      } else {
        // The person is not logged into Facebook, so we're not sure if
        // they are logged into this app or not.
        document.getElementById('info_status').innerHTML = 'You should log in first.';
      }
    }

    // This function is called when someone finishes with the Login
    // Button.  See the onlogin handler attached to it in the sample
    // code below.
    function statefeedback(response) {
        console.log('current status: ' + response.status);

	      if (response.status !== 'connected') {
	    	  document.getElementById('info_status').innerHTML = 'You should log in first.';
	    	  document.getElementById("button").disabled = true;
	      	  document.getElementById('recent-crimes').innerHTML = "Log in and see recent crimes happened in your area.";
	      	  document.getElementById('tips').innerHTML = "Log in and see those tips that can better protect you and your family.";
	      } else {
	    	  document.getElementById("button").disabled = false;
	          document.getElementById('info_status').innerHTML = 'You have successfully logged in.';
	      }
    }
  
	    function state() {
	      FB.getLoginStatus(function(response) {
	        statefeedback(response);  
	      });
   
    }


    function checkLoginState() {
    	state();
      FB.getLoginStatus(function(response) {
        statusChangeCallback(response);
      });
    }

    window.fbAsyncInit = function() {
    FB.init({
      appId      : '1634744843428649',
      cookie     : true,  // enable cookies to allow the server to access 
                          // the session
      xfbml      : true,  // parse social plugins on this page
      version    : 'v2.3' // use version 2.2
    });

    // Now that we've initialized the JavaScript SDK, we call 
    // FB.getLoginStatus().  This function gets the state of the
    // person visiting this page and can return one of three states to
    // the callback you provide.  They can be:
    //
    // 1. Logged into your app ('connected')
    // 2. Logged into Facebook, but not your app ('not_authorized')
    // 3. Not logged into Facebook and can't tell if they are logged into
    //    your app or not.
    //
    // These three cases are handled in the callback function.

    FB.getLoginStatus(function(response) {
      statusChangeCallback(response);
    });

    };

    // Load the SDK asynchronously
    (function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "//connect.facebook.net/en_US/sdk.js";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));

    var updateReq = new Object();
    
    // Here we run a very simple test of the Graph API after login is
    // successful.  See statusChangeCallback() for when this call is made.
    function CheckUser() {
      console.log('Welcome!  Fetching your information.... ');
      FB.api('/me', function(response) {
        console.log('Successful login for: ' + response.name);
        console.log(response);
        var request = new XMLHttpRequest();
        request.onload = reqListener;
        request.open("POST", "Registration", true);
        var obj = new Object();
        obj.id = response.id;
        updateReq.id = response.id;
        obj.first_name = response.first_name;
        obj.last_name = response.last_name;
        obj.email = response.email;
        var jsonString= JSON.stringify(obj);
        console.log(jsonString);
        request.send(jsonString);
        getCrimes(response.id);
        getRules(response.id);
      });
    }
    
    var confirm = document.getElementById("confirm");
    confirm.addEventListener("click", function(event) {
        event.preventDefault();
        updateAddress();
    });
    
    function updateAddress() {
    	updateReq.address = document.getElementById('submit_your_address').value;
      	var request = new XMLHttpRequest();
    	request.onload = reqListener;
        request.open("PUT", "Registration", true);
        request.send(JSON.stringify(updateReq));
    }
    
    function reqListener() {
    	var response = this.responseText;
    	console.log(response);
    }
    
    function getCrimes(id) {
      	var request = new XMLHttpRequest();
    	request.onload = getCrimeListener;
        request.open("GET", "Crimes?id=" + id, true);
        request.send();
    }
    
    function getCrimeListener() {
    	var response = JSON.parse(this.responseText);
    	var crimes = "";
    	response.forEach(function(crime) {
    		crimes = crimes + crime.crime_date + " " + crime.crime_time + ": A/An " + crime.crime_type + " happened at " + crime.formatted_address + "<br/>"
    	});
    	document.getElementById('recent-crimes').innerHTML = crimes;
    }
    
    function getRules(id) {
      	var request = new XMLHttpRequest();
    	request.onload = getRulesListener;
        request.open("GET", "Rules?id=" + id, true);
        request.send();
    }
    
    function getRulesListener() {
    	var response = JSON.parse(this.responseText);
    	var rules = "";
     	response.forEach(function(rule) {
    		rules = rules + getFormattedLHS(rule.lhs) + " => " + rule.rhs + " (Confidence: " + (rule.confidence * 100).toFixed(2) + "%, Support: " + (rule.support * 100).toFixed(2) + "%)" + "<br/>"
    	});
     	rules = rules + "<br/>Notes: For the tips above, the combination of all factors on the left has a confidence to result in the crime on the right, where support indicates the probability of a crime.";
    	document.getElementById('tips').innerHTML = rules;
    }
    
    function getFormattedLHS(lhs) {
/*     	var res = lhs.replace("\"", "").replace("[", "").replace("]", "").split(",");
    	console.log(res); */
    	var lhs = JSON.parse(lhs);
    	return lhs.join(" & ");
    }
    
    
    
    </script>

</body>

</html>
